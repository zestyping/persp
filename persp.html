<style>
body { font-family: helvetica neue, sans-serif; font-size: 14px; margin: 18px; }
table th, table td { padding-right: 18px; }
#world-settings { float: right; }
#world-settings, #world-settings input { font-family: andale mono, monospace; font-size: 24px; }
.view { position: relative; }
.canvas { cursor: none; }
.cursor { position: absolute; cursor: none; z-index: 1; }
.pin { position: absolute; cursor: none; }
.message { font-family: andale mono, monospace; font-size: 24px; }
#world-rect { position: absolute; border: 1px solid black; }
th { text-align: left; font-weight: bold; padding-bottom: 6px; }
</style>

<table cellspacing=0 cellpadding=0>
  <tr>
    <th>Photo</th>
    <th>World
      <div id="world-settings">
        <input id="world-width" value="10.0" size=5>m x
        <input id="world-height" value="10.0" size=5>m
      </div>
    </th>
  </tr>
  <tr>
    <td id="photo" class="view">
      <img id="photo-canvas" class="canvas" src="photo.jpg">
      <img id="photo-cursor" class="cursor" src="cursor.png">
    </td>
    <td id="world" class="view">
      <div id="world-canvas" class="canvas">
        <div id="world-rect"></div>
      </div>
      <img id="world-cursor" class="cursor" src="cursor.png">
    </td>
  </tr>
  <tr>
    <td><pre id="photo-status" class="message"></pre></td>
    <td><pre id="world-status" class="message"></pre></td>
  </tr>
</table>

<script src="jquery-1.5.1.min.js"></script>
<script>
var PHOTO_WIDTH = 640;
var PHOTO_HEIGHT = 512;
var CURSOR_WIDTH = 17;
var CURSOR_HEIGHT = 17;
var PIN_WIDTH = 27;
var PIN_HEIGHT = 27;
var PIN_HIT_RADIUS = 10;

var photo = $('#photo')[0];
var photoCanvas = $('#photo-canvas')[0];
var photoCursor = $('#photo-cursor')[0];
var world = $('#world')[0];
var worldCanvas = $('#world-canvas')[0];
var worldCursor = $('#world-cursor')[0];
var worldRect = $('#world-rect')[0];

photoCanvas.style.width = PHOTO_WIDTH + 'px';
photoCanvas.style.height = PHOTO_HEIGHT + 'px';
worldCanvas.style.width = PHOTO_WIDTH + 'px';
worldCanvas.style.height = PHOTO_HEIGHT + 'px';

var hoveredPin = null;
var grabbedPin = null;
var pins = [
  {'photo': [PHOTO_WIDTH * 0.2, PHOTO_HEIGHT * 0.8], 'world': [0, 0]},
  {'photo': [PHOTO_WIDTH * 0.8, PHOTO_HEIGHT * 0.8], 'world': [10, 0]},
  {'photo': [PHOTO_WIDTH * 0.2, PHOTO_HEIGHT * 0.2], 'world': [0, 10]},
  {'photo': [PHOTO_WIDTH * 0.8, PHOTO_HEIGHT * 0.2], 'world': [10, 10]},
];

for (var i = 0; i < pins.length; i++) {
  pins[i].photoImg = $('<img class="pin" src="pin.png">')[0];
  pins[i].worldImg = $('<img class="pin" src="pin.png">')[0];
  $('#photo').append(pins[i].photoImg);
  $('#world').append(pins[i].worldImg);
}

function showPin(pinImg, canvas, x, y) {
  pinImg.style.left = (canvas.offsetLeft + x - (PIN_WIDTH - 1)/2) + 'px';
  pinImg.style.top = (canvas.offsetTop + y - (PIN_HEIGHT - 1)/2) + 'px';
  pinImg.style.width = PIN_WIDTH + 'px';
  pinImg.style.height = PIN_HEIGHT + 'px';
}

function updatePin(pin) {
  showPin(pin.photoImg, photoCanvas, pin.photo[0], pin.photo[1]);
  var wpx = worldOriginX + pin.world[0]*worldScale;
  var wpy = worldOriginY - pin.world[1]*worldScale;
  showPin(pin.worldImg, worldCanvas, wpx, wpy);
}

function updatePins() {
  for (var i = 0; i < pins.length; i++) {
    updatePin(pins[i]);
  }
}

function highlightPin(pin) {
  for (var i = 0; i < pins.length; i++) {
    pins[i].photoImg.src = pins[i].worldImg.src =
        (pins[i] === pin) ? 'highlighted-pin.png' : 'pin.png';
  }
}

var worldWidth;
var worldHeight;
var worldOriginX;
var worldOriginY;
var worldScale;

function updateWorldRect() {
  worldWidth = $('#world-width').val() - 0;
  worldHeight = $('#world-height').val() - 0;
  worldScale = Math.min((PHOTO_WIDTH * 0.8) / worldWidth,
                        (PHOTO_HEIGHT * 0.8) / worldHeight);
  worldOriginX = (PHOTO_WIDTH / 2) - (worldWidth*worldScale / 2);
  worldOriginY = (PHOTO_HEIGHT / 2) + (worldHeight*worldScale / 2);
  worldRect.style.left = worldOriginX + 'px';
  worldRect.style.top = (worldOriginY - worldHeight*worldScale) + 'px';
  worldRect.style.width = (worldWidth*worldScale - 1) + 'px';
  worldRect.style.height = (worldHeight*worldScale - 1) + 'px';
  pins[0].world = [0, 0];
  pins[1].world = [worldWidth, 0];
  pins[2].world = [0, worldHeight];
  pins[3].world = [worldWidth, worldHeight];
  updatePins();
}

updateWorldRect();
$('#world-settings input').change(updateWorldRect);

function showCursor(cursor, canvas, x, y) {
  cursor.style.display = 'block';
  cursor.style.left = (canvas.offsetLeft + x - (CURSOR_WIDTH - 1)/2) + 'px';
  cursor.style.top = (canvas.offsetTop + y - (CURSOR_HEIGHT - 1)/2) + 'px';
  cursor.style.width = CURSOR_WIDTH + 'px';
  cursor.style.height = CURSOR_HEIGHT + 'px';
}

function showPhotoCursor(x, y) {
  if (x >= 0 && x < PHOTO_WIDTH && y >= 0 && y < PHOTO_HEIGHT) {
    showCursor(photoCursor, photoCanvas, x, y);
  } else {
    photoCursor.style.display = 'none';
  }
}

function showWorldCursor(x, y) {
  var cx = worldOriginX + x*worldScale;
  var cy = worldOriginY - y*worldScale;
  if (cx >= 0 && cx < PHOTO_WIDTH && cy >= 0 && cy < PHOTO_HEIGHT) {
    showCursor(worldCursor, worldCanvas, cx, cy);
  } else {
    worldCursor.style.display = 'none';
  }
}

function updateCursors(photoXy, worldXy) {
  var px = Math.floor(photoXy[0]), py = Math.floor(photoXy[1]);
  var wx = worldXy[0], wy = worldXy[1];
  showPhotoCursor(px, py);
  showWorldCursor(wx, wy);
  $('#photo-status').text('x = ' + px + '\n' +
                          'y = ' + py);
  $('#world-status').text('x = ' + wx.toFixed(2) + 'm\n' +
                          'y = ' + wy.toFixed(2) + 'm');
}

function hideCursors() {
  $('#photo-status').text('');
  $('#world-status').text('');
  photoCursor.style.display = 'none';
  worldCursor.style.display = 'none';
}

function photoToWorld(x, y) {
  var xl = pins[0].photo[0];
  var yl = pins[0].photo[1];
  var xh = pins[3].photo[0];
  var yh = pins[3].photo[1];
  return [(x - xl) / (xh - xl) * worldWidth,
          (y - yl) / (yh - yl) * worldHeight];
}

function worldToPhoto(x, y) {
  var xl = pins[0].photo[0];
  var yl = pins[0].photo[1];
  var xh = pins[3].photo[0];
  var yh = pins[3].photo[1];
  return [xl + (xh - xl) * (x / worldWidth),
          yl + (yh - yl) * (y / worldHeight)];
}

photo.addEventListener('click', function(event) {
  if (grabbedPin) {  // drop it
    showPhotoCursor(grabbedPin.photo[0], grabbedPin.photo[1]);
    grabbedPin = null;
  } else {
    if (hoveredPin) {  // grab it
      hideCursors();
      grabbedPin = hoveredPin;
    }
  }
});

photo.addEventListener('mousemove', function(event) {
  var offset = $('#photo-canvas').offset();
  var x = event.pageX - offset.left;
  var y = event.pageY - offset.top;
  if (x >= 0 && x < PHOTO_WIDTH && y >= 0 && y < PHOTO_HEIGHT) {
    if (grabbedPin) {
      hideCursors();
      grabbedPin.photo[0] = x;
      grabbedPin.photo[1] = y;
      updatePin(grabbedPin);
    } else {
      updateCursors([x, y], photoToWorld(x, y));
      hoveredPin = null;
      for (var i = 0; i < pins.length; i++) {
        if (Math.abs(pins[i].photo[0] - x) < PIN_HIT_RADIUS &&
            Math.abs(pins[i].photo[1] - y) < PIN_HIT_RADIUS) {
          hoveredPin = pins[i];
        }
      }
      highlightPin(hoveredPin);
    }
  } else {
    hideCursors();
  }
});

world.addEventListener('mousemove', function(event) {
  var offset = $('#world-canvas').offset();
  var x = event.pageX - offset.left;
  var y = event.pageY - offset.top;
  if (x >= 0 && x < PHOTO_WIDTH && y >= 0 && y < PHOTO_HEIGHT) {
    var wx = (x - worldOriginX) / worldScale;
    var wy = (worldOriginY - y) / worldScale;
    updateCursors(worldToPhoto(wx, wy), [wx, wy]);
  } else {
    hideCursors();
  }
});
</script>
